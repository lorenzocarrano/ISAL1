%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
% This will help you in writing your homebook
% Remember that the character % is a comment in latex
%
% chapter 3
\chapter{Advanced architecture development}
\label{cha3}

In this section the purpose is to improve the FIR performance. Initially the unfolding 
technique has been applied to improve the throughput, then pipeline technique has 
been implemented to reduce the critical path and improve the maximum clock frequency.

\section{Unfolding}

Unfolding of order 3 has been applied to FIR filter (N = 3) and the equations derived
to build the new system are the following:

\begin{equation}
\begin{split}
    y[3n] = a_0 \cdot x[3n] + a_1 \cdot x[3(n-1) + 2] + a_2 \cdot x[3(n-1) + 1] + \\
    a_3 \cdot x[3(n-1)] + a_4 \cdot x[3(n-2) + 2] + a_5 \cdot x[3(n-2) + 1] + a_6 \cdot x[3(n-2)] +  \\
    a_7 \cdot x[3(n-3) + 2] + a_8 \cdot x[3(n-3) + 1] + a_9 \cdot x[3(n-3)] + a_{10} \cdot x[3(n-4) + 2]
\end{split}
\end{equation}

\begin{equation}
\begin{split}
    y[3n + 1] = a_0 \cdot x[3n + 1] + a_1 \cdot x[3n] + a_2 \cdot x[3(n-1) + 2] + \\
    a_3 \cdot x[3(n-1) + 1] + a_4 \cdot x[3(n-1)] + a_5 \cdot x[3(n-2) + 2] + a_6 \cdot x[3(n-2)+1] +  \\
    a_7 \cdot x[3(n-2)] + a_8 \cdot x[3(n-3)+2] + a_9 \cdot x[3(n-3) + 1] + a_{10} \cdot x[3(n-3)]
\end{split}
\end{equation}

\begin{equation}
\begin{split}
    y[3n + 2] = a_0 \cdot x[3n + 2] + a_1 \cdot x[3n + 1] + a_2 \cdot x[3n] + a_3 \cdot x[3(n-1) + 2] +\\
    a_4 \cdot x[3(n-1) + 1] + a_5 \cdot x[3(n-1)] + a_6 \cdot x[3(n-2) + 2] +  a_7 \cdot x[3(n-3) + 1] +\\
    a_8 \cdot x[3(n-2)] + a_9 \cdot x[3(n-3) + 2] + a_[10] \cdot x[3(n-3) + 1]
\end{split}
\end{equation}

Using this method of optimization the two more input and output ports have been added because
now 3 inputs are processed and produce, at the same time, 3 outputs. The overall throughput has
been triplicated.

%% formula dove facciamo vedere che il throuput Ã¨ triplicato e il nuovo valore calcolato

\section{Pipeline}

A further optimization has been applied. This method allows to reduce the size of critical path.

From the schematic of the unfolded FIR is possible to see that to reduce the critical path a chain of registers
is needed to separate the multipliers from the adders. After these registers are added, the new critical path 
becomes the long chain of adders at the bottom of the scheme.
A register is added in the middle of the adder chain; by doing so, it is necessary to delay the stages of the filter
that are positioned behind the new register. Also VIN has to be carefully delayed according to which register it is enabling.

After the optimization, the new critical path corresponds to a single multiplier, so it is not possible to improve it more
without adding pipelining to the arithmetic blocks.

To simulate the advanced implementation of the filter the testbench had to be modified. The data\_sink and data\_maker were
updated in order to be able to transmit and receive 3 inputs every clock cycle.

